<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Temple of Logic – Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    h1, h2 {
      color: #ffd700;
    }
    .box {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid #444;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 5px;
      border: none;
      background: #333;
      color: white;
    }
    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn-primary {
      background: #007bff;
    }
    .btn-danger {
      background: #cc0000;
      color: white;
    }
    .entry {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #555;
      padding: 10px 0;
      margin: 5px 0;
    }
    img.thumb {
      height: 40px;
      border-radius: 5px;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h1>TOL Adminbereich</h1>

  <!-- =============================================================== -->
  <!-- KLASSEN -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>Klassen</h2>
    <input id="class-name" placeholder="Neue Klasse" />
    <button class="btn-primary" onclick="addClass()">Klasse anlegen</button>

    <div id="class-list"></div>
  </div>

  <!-- =============================================================== -->
  <!-- SCHÜLER -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>Schüler:innen</h2>

    <select id="student-class-select" onchange="loadStudents()"></select>

    <input id="student-name" placeholder="Name" />
    <input id="student-password" placeholder="Passwort" type="password" />
    <button class="btn-primary" onclick="addStudent()">Schüler anlegen</button>

    <div id="student-list"></div>
  </div>

  <!-- =============================================================== -->
  <!-- XP VERGABE -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>XP-Vergabe</h2>

    <select id="xp-class-select"></select>

    <input id="xp-amount" type="number" placeholder="XP Menge" />

    <button class="btn-primary" onclick="giveXPClass()">XP an ganze Klasse</button>

    <div id="xp-student-list"></div>

    <h3>Missionen vergeben</h3>
    <select id="xp-mission-select"></select>
    <button class="btn-primary" onclick="giveMissionClass()">Mission an Klasse</button>
    <button class="btn-primary" onclick="giveMissionStudents()">Mission an ausgewählte Schüler</button>
  </div>

  <!-- =============================================================== -->
  <!-- MISSIONEN -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>Missionen</h2>

    <input id="mission-title" placeholder="Titel" />
    <input id="mission-xp" type="number" placeholder="XP Belohnung" />

    <label>
      Bild:
      <input type="file" id="mission-image" />
    </label>

    <label>
      <input type="checkbox" id="mission-requires-upload" />
      Upload durch Schüler erforderlich
    </label>

    <button class="btn-primary" onclick="createMission()">Mission anlegen</button>

    <div id="mission-list"></div>
  </div>

  <!-- =============================================================== -->
  <!-- BONUSKARTEN -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>Bonuskarten</h2>

    <input id="bonus-title" placeholder="Titel" />
    <input id="bonus-cost" type="number" placeholder="XP Kosten" />

    <label>Bild:
      <input type="file" id="bonus-image" />
    </label>

    <button class="btn-primary" onclick="createBonus()">Bonuskarte anlegen</button>

    <div id="bonus-list"></div>
  </div>

  <!-- =============================================================== -->
  <!-- CHARAKTERE -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>Charaktere</h2>

    <input id="char-name" placeholder="Name" />

    <label>Bild:
      <input type="file" id="char-image" />
    </label>

    <button class="btn-primary" onclick="createChar()">Charakter anlegen</button>

    <div id="char-list"></div>
  </div>

  <!-- =============================================================== -->
  <!-- LEVEL -->
  <!-- =============================================================== -->
  <div class="box">
    <h2>Level</h2>

    <input id="level-name" placeholder="Levelname" />
    <input id="level-xp" type="number" min="0" placeholder="Benötigte XP" />
    <input id="level-desc" placeholder="Beschreibung (optional)" />

    <button class="btn-primary" onclick="createLevel()">Level anlegen</button>

    <div id="level-list"></div>
  </div>

  <!-- =============================================================== -->
  <!-- SCRIPT -->
  <!-- =============================================================== -->
  <script>
    // ============================================================
    // Klassen
    // ============================================================
    async function loadClasses() {
      const res = await fetch("/api/admin/classes");
      const data = await res.json();

      const clsSel = document.getElementById("student-class-select");
      const xpSel = document.getElementById("xp-class-select");

      clsSel.innerHTML = "";
      xpSel.innerHTML = "";
      document.getElementById("class-list").innerHTML = "";

      data.classes.forEach((c) => {
        clsSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        xpSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;

        document.getElementById("class-list").innerHTML += `
          <div class="entry">
            ${c.name}
            <button class="btn-danger" onclick="deleteClass(${c.id})">Löschen</button>
          </div>
        `;
      });

      loadStudents();
      loadXPStudentList();
    }

    async function addClass() {
      const name = document.getElementById("class-name").value;
      await fetch("/api/admin/classes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name }),
      });
      document.getElementById("class-name").value = "";
      loadClasses();
    }

    async function deleteClass(id) {
      await fetch(`/api/admin/classes/${id}`, { method: "DELETE" });
      loadClasses();
    }

    // ============================================================
    // Schüler
    // ============================================================
    async function loadStudents() {
      const classId = document.getElementById("student-class-select").value;
      const res = await fetch(`/api/admin/students/${classId}`);
      const students = await res.json();

      const box = document.getElementById("student-list");
      box.innerHTML = "";

      students.forEach((s) => {
        box.innerHTML += `
          <div class="entry">
            ${s.name} (XP: ${s.xp})
            <button class="btn-danger" onclick="deleteStudent(${s.id})">Löschen</button>
          </div>
        `;
      });
    }

    async function addStudent() {
      const classId = document.getElementById("student-class-select").value;
      const name = document.getElementById("student-name").value;
      const password = document.getElementById("student-password").value;

      await fetch("/api/admin/students", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, password, class_id: classId }),
      });

      document.getElementById("student-name").value = "";
      document.getElementById("student-password").value = "";
      loadStudents();
    }

    async function deleteStudent(id) {
      await fetch(`/api/admin/students/${id}`, { method: "DELETE" });
      loadStudents();
    }

    // ============================================================
    // XP
    // ============================================================
    async function loadXPStudentList() {
      const classId = document.getElementById("xp-class-select").value;
      const res = await fetch(`/api/admin/students/${classId}`);
      const students = await res.json();

      const box = document.getElementById("xp-student-list");
      box.innerHTML = "";

      students.forEach((s) => {
        box.innerHTML += `
          <div class="entry">
            <label>
              <input type="checkbox" value="${s.id}" />
              ${s.name} (${s.xp} XP)
            </label>
          </div>`;
      });
    }

    async function giveXPClass() {
      const classId = document.getElementById("xp-class-select").value;
      const xp = Number(document.getElementById("xp-amount").value);
      if (!xp) return alert("XP eingeben!");

      await fetch("/api/admin/xp/class", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ class_id: classId, amount: xp }),
      });

      loadXPStudentList();
      loadStudents();
    }

    async function giveMissionClass() {
      const classId = document.getElementById("xp-class-select").value;
      const missionId = document.getElementById("xp-mission-select").value;

      await fetch("/api/admin/xp/mission-class", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ class_id: classId, mission_id: missionId }),
      });

      loadXPStudentList();
      loadStudents();
    }

    async function giveMissionStudents() {
      const missionId = document.getElementById("xp-mission-select").value;
      const checkboxes = document.querySelectorAll("#xp-student-list input[type=checkbox]:checked");

      const ids = [...checkboxes].map((c) => Number(c.value));

      await fetch("/api/admin/xp/mission-students", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ student_ids: ids, mission_id: missionId }),
      });

      loadXPStudentList();
      loadStudents();
    }

    // ============================================================
    // Missionen
    // ============================================================
    async function loadMissions() {
      const res = await fetch("/api/admin/missions");
      const missions = await res.json();

      const box = document.getElementById("mission-list");
      const xpSel = document.getElementById("xp-mission-select");

      box.innerHTML = "";
      xpSel.innerHTML = "";

      missions.forEach((m) => {
        xpSel.innerHTML += `<option value="${m.id}">${m.title}</option>`;
        box.innerHTML += `
          <div class="entry">
            <div>
              ${m.image_url ? `<img class="thumb" src="${m.image_url}">` : ""}
              <strong>${m.title}</strong> – ${m.xp_reward} XP
            </div>
            <button class="btn-danger" onclick="deleteMission(${m.id})">Löschen</button>
          </div>`;
      });
    }

    async function createMission() {
      const f = new FormData();
      f.append("title", document.getElementById("mission-title").value);
      f.append("xp_reward", document.getElementById("mission-xp").value);

      if (document.getElementById("mission-image").files[0]) {
        f.append("image", document.getElementById("mission-image").files[0]);
      }

      f.append("requires_upload", document.getElementById("mission-requires-upload").checked);

      await fetch("/api/admin/missions", { method: "POST", body: f });

      document.getElementById("mission-title").value = "";
      document.getElementById("mission-xp").value = "";
      document.getElementById("mission-image").value = "";
      document.getElementById("mission-requires-upload").checked = false;

      loadMissions();
    }

    async function deleteMission(id) {
      await fetch(`/api/admin/missions/${id}`, { method: "DELETE" });
      loadMissions();
    }

    // ============================================================
    // Bonuskarten
    // ============================================================
    async function loadBonus() {
      const res = await fetch("/api/admin/bonus");
      const bonus = await res.json();

      const box = document.getElementById("bonus-list");
      box.innerHTML = "";

      bonus.forEach((b) => {
        box.innerHTML += `
          <div class="entry">
            ${b.image_url ? `<img class="thumb" src="${b.image_url}">` : ""}
            <strong>${b.title}</strong> – kostet ${b.xp_cost} XP
            <button class="btn-danger" onclick="deleteBonus(${b.id})">Löschen</button>
          </div>`;
      });
    }

    async function createBonus() {
      const f = new FormData();
      f.append("title", document.getElementById("bonus-title").value);
      f.append("xp_cost", document.getElementById("bonus-cost").value);

      if (document.getElementById("bonus-image").files[0]) {
        f.append("image", document.getElementById("bonus-image").files[0]);
      }

      await fetch("/api/admin/bonus", { method: "POST", body: f });

      document.getElementById("bonus-title").value = "";
      document.getElementById("bonus-cost").value = "";
      document.getElementById("bonus-image").value = "";

      loadBonus();
    }

    async function deleteBonus(id) {
      await fetch(`/api/admin/bonus/${id}`, { method: "DELETE" });
      loadBonus();
    }

    // ============================================================
    // Charaktere
    // ============================================================
    async function loadCharacters() {
      const res = await fetch("/api/admin/characters");
      const chars = await res.json();

      const box = document.getElementById("char-list");
      box.innerHTML = "";

      chars.forEach((c) => {
        box.innerHTML += `
          <div class="entry">
            ${c.image_url ? `<img class="thumb" src="${c.image_url}">` : ""}
            <strong>${c.name}</strong>
            <button class="btn-danger" onclick="deleteChar(${c.id})">Löschen</button>
          </div>`;
      });
    }

    async function createChar() {
      const f = new FormData();
      f.append("name", document.getElementById("char-name").value);

      if (document.getElementById("char-image").files[0]) {
        f.append("image", document.getElementById("char-image").files[0]);
      }

      await fetch("/api/admin/characters", { method: "POST", body: f });

      document.getElementById("char-name").value = "";
      document.getElementById("char-image").value = "";

      loadCharacters();
    }

    async function deleteChar(id) {
      await fetch(`/api/admin/characters/${id}`, { method: "DELETE" });
      loadCharacters();
    }

    // ============================================================
    // LEVEL (NEU)
    // ============================================================
    async function loadLevels() {
      const res = await fetch("/api/admin/levels");
      const levels = await res.json();

      const box = document.getElementById("level-list");
      box.innerHTML = "";

      levels.forEach((lvl) => {
        box.innerHTML += `
          <div class="entry">
            <div>
              <strong>${lvl.name}</strong><br>
              XP nötig: ${lvl.xp_required}
              ${lvl.description ? `<br><small>${lvl.description}</small>` : ""}
            </div>
            <button class="btn-danger" onclick="deleteLevel(${lvl.id})">Löschen</button>
          </div>`;
      });
    }

    async function createLevel() {
      const name = document.getElementById("level-name").value.trim();
      const xpStr = document.getElementById("level-xp").value.trim();
      const desc = document.getElementById("level-desc").value.trim();

      if (!name) return alert("Levelname fehlt.");
      if (xpStr === "") return alert("XP angeben (z. B. 0, 100…).");

      const xp = Number(xpStr);
      if (!Number.isInteger(xp) || xp < 0)
        return alert("XP muss eine Zahl ≥ 0 sein.");

      await fetch("/api/admin/levels", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, xp_required: xp, description: desc }),
      });

      document.getElementById("level-name").value = "";
      document.getElementById("level-xp").value = "";
      document.getElementById("level-desc").value = "";

      loadLevels();
    }

    async function deleteLevel(id) {
      await fetch(`/api/admin/levels/${id}`, { method: "DELETE" });
      loadLevels();
    }

    // ============================================================
    // INIT
    // ============================================================
    loadClasses();
    loadMissions();
    loadBonus();
    loadCharacters();
    loadLevels();

    document
      .getElementById("xp-class-select")
      ?.addEventListener("change", loadXPStudentList);
  </script>
</body>
</html>
